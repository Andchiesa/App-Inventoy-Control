<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Controlo de Inventário - Shopee</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Visualization (loader chama JSONP internamente) -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body{font-family:'Inter',sans-serif}
    .shopee-orange{background:#EE4D2D}.shopee-orange-text{color:#EE4D2D}
    .sidebar-item.active{background:#EE4D2D;color:#fff}.sidebar-item.active svg{color:#fff}
    .sidebar-item{transition:.2s}.sidebar-item:hover{background:#fde8e4}
    .kpi-card{transition:.2s;border:1px solid #e2e8f0}.kpi-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgb(0 0 0 /.1),0 4px 6px -4px rgb(0 0 0 /.1);border-color:#EE4D2D}
    ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#f1f1f1}::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:10px}::-webkit-scrollbar-thumb:hover{background:#9ca3af}
    #loader{border-top-color:#EE4D2D}
    .date-filter-btn.active{background:#EE4D2D;color:#fff;border-color:#EE4D2D}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- ========= LOADING SCREEN ================================================= -->
<div id="loading-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50 transition-opacity">
  <div id="loader" class="w-16 h-16 border-4 border-gray-200 rounded-full animate-spin"></div>
  <p id="loading-text"  class="mt-4 text-lg font-semibold text-gray-700">A carregar dados da planilha…</p>
  <p id="loading-error" class="mt-2 text-red-600 hidden text-center max-w-lg font-medium p-4 bg-red-50 rounded-lg border border-red-200"></p>
</div>

<!-- ========= LAYOUT (mesmo que o seu) ====================================== -->
<div class="flex h-screen">
  <!-- Sidebar … (SEM ALTERAÇÃO) -->
  <!-- … todo o markup da sidebar e das páginas continua igual … -->
</div>

<!-- =============================  SCRIPT  =================================== -->
<script>
/* ---------- CONFIGURAÇÃO DAS ABAS ---------------------------------------- */
// ID publicado da planilha (é a parte “2PACX-…N7hGYq”)
const SHEET_BASE =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq';

const SHEETS = {
  spx        : 205074627,
  avarias    : 227777912,
  naoCoube   : 39642381,
  lost       : 1070430125,
  looping    : 1464396391,
  realocados : 300854873
};

/* ---------- VARIÁVEIS GLOBAIS & UI (SEU CÓDIGO ORIGINAL) ------------------ */
let originalData = {};
let currentPeriod = 'today';
const pages = ['visao-geral','analise-avarias','nao-coube','looping','realocados'];
// … todas as funções de navegação, parseDate, renderização etc. permanecem IGUAIS …


/* ---------- (NOVO) UTIL PARA CONVERTER DataTable → Array de Objetos ------- */
function dataTableToObjects(dt){
  const cols = Array.from({length:dt.getNumberOfColumns()},(_,i)=>dt.getColumnLabel(i));
  const rows = [];
  for(let r=0;r<dt.getNumberOfRows();r++){
    const obj={};
    cols.forEach((c,i)=>{ obj[c]=dt.getValue(r,i)??'' });
    rows.push(obj);
  }
  return rows;
}

/* ---------- (NOVO) CARREGAMENTO VIA JSONP --------------------------------- */
function loadSheet(key,gid){
  return new Promise((resolve,reject)=>{
    const url = `${SHEET_BASE}/gviz/tq?gid=${gid}`;
    const query = new google.visualization.Query(url);
    query.send(resp=>{
      if(resp.isError()){
        reject(new Error(`Falha ao buscar a aba '${key}': ${resp.getMessage()}`));
        return;
      }
      const dataTable = resp.getDataTable();
      resolve([key, dataTableToObjects(dataTable)]);
    });
  });
}

/* ---------- INICIALIZAÇÃO ------------------------------------------------- */
google.charts.load('current',{'packages':['corechart']}); // qualquer pacote
google.charts.setOnLoadCallback(init);

async function init(){
  const loadingError=document.getElementById('loading-error');
  const loadingText =document.getElementById('loading-text');
  const loader      =document.getElementById('loader');

  try{
    const promises = Object.entries(SHEETS)
      .map(([k,g])=> loadSheet(k,g));
    const all      = await Promise.all(promises);
    originalData   = Object.fromEntries(all);

    document.getElementById('last-updated').textContent =
      new Date().toLocaleTimeString('pt-BR');

    document.getElementById('loading-overlay').style.opacity=0;
    setTimeout(()=>document.getElementById('loading-overlay').style.display='none',300);

    renderDashboard();

  }catch(err){
    loadingText.style.display='none';
    loader.style.display='none';
    loadingError.innerHTML =
      `<b>Falha ao Carregar Dados:</b><br>${err.message}<br><br>
       Verifique se a planilha está realmente “Publicada na Web” e com acesso
       “Qualquer pessoa com o link”.`;
    loadingError.classList.remove('hidden');
  }
}

/* ---------- Evento dos botões de período (igual) -------------------------- */
document.getElementById('date-filters').addEventListener('click',e=>{
  if(e.target.tagName==='BUTTON'){
    document.querySelectorAll('.date-filter-btn').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    currentPeriod = e.target.dataset.period;
    renderDashboard();
  }
});
</script>
</body>
</html>
