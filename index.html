<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Controle de Inventário - Shopee</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .shopee-orange { background-color: #EE4D2D; }
        .shopee-orange-text { color: #EE4D2D; }
        .sidebar-item.active { background-color: #EE4D2D; color: white; }
        .sidebar-item.active svg { color: white; }
        .sidebar-item { transition: all 0.2s ease-in-out; }
        .sidebar-item:hover { background-color: #fde8e4; }
        .kpi-card { transition: all 0.2s ease-in-out; border: 1px solid #e2e8f0; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); border-color: #EE4D2D; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        #loader { border-top-color: #EE4D2D; }
        .date-filter-btn.active { background-color: #EE4D2D; color: white; border-color: #EE4D2D;}
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Tela de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
        <div id="loader" class="w-16 h-16 border-4 border-gray-200 border-solid rounded-full animate-spin"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">Carregando dados da planilha...</p>
        <p id="loading-error" class="mt-2 text-red-500 hidden text-center max-w-md"></p>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md flex-shrink-0">
            <div class="p-6 flex items-center justify-center border-b"><img src="https://i.imgur.com/9QWcgRj.png" alt="Shopee Logo" class="h-10"></div>
            <nav class="mt-6">
                <a href="#" id="nav-visao-geral" class="sidebar-item active flex items-center py-3 px-6 text-gray-600" onclick="showPage('visao-geral')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 shopee-orange-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>Visão Geral</span></a>
                <a href="#" id="nav-analise-avarias" class="sidebar-item flex items-center py-3 px-6 text-gray-600" onclick="showPage('analise-avarias')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Análise de Avarias</span></a>
                <a href="#" id="nav-nao-coube" class="sidebar-item flex items-center py-3 px-6 text-gray-600" onclick="showPage('nao-coube')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 18H5a2 2 0 01-2-2V8a2 2 0 012-2h5m5 4v6m0-6l-3-3m3 3l3-3" /></svg><span>Não Coube</span></a>
            </nav>
        </aside>

        <!-- Main Content (conteúdo principal) -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-8">
                <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Dashboard de Controle de Inventário</h1>
                        <p class="text-gray-500 mt-1">Atualizado a cada 5 minutos. Última busca: <span id="last-updated"></span></p>
                    </div>
                    <div id="date-filters" class="flex items-center space-x-2">
                         <button class="date-filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm border hover:bg-gray-100 transition-colors" data-period="all">Tudo</button>
                        <button class="date-filter-btn active bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm border hover:bg-gray-100 transition-colors" data-period="today">Hoje</button>
                        <button class="date-filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm border hover:bg-gray-100 transition-colors" data-period="week">Esta Semana</button>
                        <button class="date-filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm border hover:bg-gray-100 transition-colors" data-period="month">Este Mês</button>
                    </div>
                </header>

                <!-- As páginas serão renderizadas aqui -->
                <div id="page-visao-geral">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm"><h3 class="text-gray-500 text-sm font-medium">Total de Pedidos</h3><p id="kpi-total-pedidos" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm"><h3 class="text-gray-500 text-sm font-medium">Pedidos em Rota</h3><p id="kpi-em-rota" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm"><h3 class="text-gray-500 text-sm font-medium">Avarias Registradas</h3><p id="kpi-avarias" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm"><h3 class="text-gray-500 text-sm font-medium">Pedidos Perdidos (Lost)</h3><p id="kpi-lost" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-semibold mb-4">Volume de Pedidos por Status</h3><div id="chart-status-pedidos" class="space-y-4"></div></div>
                </div>

                <div id="page-analise-avarias" class="hidden">
                    <!-- Conteúdo preenchido por JavaScript -->
                </div>

                <div id="page-nao-coube" class="hidden">
                     <!-- Conteúdo preenchido por JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        // COLE AQUI AS URLs PÚBLICAS DE CSV DA SUA PLANILHA
        const SHEET_URLS = {
            spx_Looping': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq/pub?gid=205074627&single=true&output=csv',
            avarias: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq/pub?gid=227777912&single=true&output=csv',
            naoCoube: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq/pub?gid=39642381&single=true&output=csv',
            lost: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq/pub?gid=1070430125&single=true&output=csv'
            looping: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq/pub?gid=1464396391&single=true&output=csv'
            realocados: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS3_ZEZVGeQLsyoqZofdqGnNH9AVtwA6ZmPgpxh6JbWI8zYr-LvOTM2bZ9Qc5iozcjtXmrm_N7hGYq/pub?gid=300854873&single=true&output=csv'
            // Adicione mais abas se precisar, ex: onHold: 'URL_AQUI'
        };

        let originalData = {};
        let currentPeriod = 'today';

        function showPage(pageId) { /* ... Lógica de navegação ... */ }

        /**
         * Converte texto CSV em um array de objetos JSON.
         * @param {string} csvText O texto CSV a ser convertido.
         * @returns {Array<Object>}
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const headers = lines.shift().split(',').map(h => h.trim());
            return lines.map(line => {
                // Regex para separar por vírgulas, mas ignorar vírgulas dentro de aspas
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const row = {};
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i];
                    let value = (values[i] || '').trim();
                    // Remove aspas do início e fim se existirem
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    row[header] = value;
                }
                return row;
            });
        }

        function parseDate(dateString) { /* ... Lógica de data ... */ }
        function filterDataByPeriod(data, dateColumn) { /* ... Lógica de filtro ... */ }

        // --- FUNÇÕES DE ATUALIZAÇÃO DO DASHBOARD (renderDashboard, updateVisaoGeral, etc.) ---
        // Elas são idênticas à versão do Apps Script, então foram omitidas aqui para economizar espaço
        // O código completo está abaixo.

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingError = document.getElementById('loading-error');
            
            // Verifica se as URLs foram preenchidas
            if (Object.values(SHEET_URLS).some(url => url.includes('COLE_A_URL'))) {
                loadingError.innerHTML = '<b>Erro de Configuração:</b><br>Por favor, cole as URLs de CSV publicadas da sua planilha na variável `SHEET_URLS` dentro do código deste arquivo HTML.';
                loadingError.classList.remove('hidden');
                document.getElementById('loader').style.display = 'none';
                return;
            }

            try {
                // Busca os dados de todas as URLs em paralelo
                const responses = await Promise.all(
                    Object.entries(SHEET_URLS).map(([key, url]) => 
                        fetch(url).then(res => {
                            if (!res.ok) throw new Error(`Falha ao buscar a aba '${key}'`);
                            return res.text();
                        })
                    )
                );
                
                // Converte cada CSV em JSON
                const dataKeys = Object.keys(SHEET_URLS);
                responses.forEach((csvText, index) => {
                    const key = dataKeys[index];
                    originalData[key] = parseCSV(csvText);
                });

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('pt-BR');
                document.getElementById('loading-overlay').style.display = 'none';
                
                renderDashboard();

            } catch (error) {
                 loadingError.textContent = `Falha ao carregar dados: ${error.message}. Verifique os links e se as abas foram publicadas corretamente.`;
                 loadingError.classList.remove('hidden');
            }
        });
        
        document.getElementById('date-filters').addEventListener('click', (e) => { /* ... Lógica dos botões de data ... */ });

        // --- O CÓDIGO COMPLETO DAS FUNÇÕES DE RENDERIZAÇÃO ---
        // (Copie e cole este bloco inteiro no seu script)
        function renderDashboard() {
            if (!originalData.spx) return;
            const filteredSpx = filterDataByPeriod(originalData.spx, 'Received Time');
            const filteredAvarias = filterDataByPeriod(originalData.avarias, 'Data');
            const filteredLost = filterDataByPeriod(originalData.lost, 'Inventory Date');
            const filteredNaoCoube = filterDataByPeriod(originalData.naoCoube, 'Data');
            updateVisaoGeral(filteredSpx, filteredAvarias, filteredLost);
            renderAnaliseAvarias(filteredAvarias);
            renderNaoCoube(filteredNaoCoube);
        }
        function updateVisaoGeral(spxData, avariasData, lostData) {
            document.getElementById('kpi-total-pedidos').textContent = spxData.length.toLocaleString('pt-BR');
            document.getElementById('kpi-em-rota').textContent = spxData.filter(d => d.Status === 'Delivering').length.toLocaleString('pt-BR');
            document.getElementById('kpi-avarias').textContent = avariasData.length.toLocaleString('pt-BR');
            document.getElementById('kpi-lost').textContent = lostData.length.toLocaleString('pt-BR');
            const statusCounts = spxData.reduce((acc, row) => { const status = row.Status || 'Indefinido'; acc[status] = (acc[status] || 0) + 1; return acc; }, {});
            const chartContainer = document.getElementById('chart-status-pedidos');
            chartContainer.innerHTML = ''; const total = spxData.length;
            for (const [status, count] of Object.entries(statusCounts)) {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                chartContainer.innerHTML += `<div class="flex items-center"><span class="w-28 text-sm text-gray-600">${status}</span><div class="w-full bg-gray-200 rounded-full h-4"><div class="shopee-orange h-4 rounded-full" style="width: ${percentage}%"></div></div><span class="w-16 text-right text-sm font-medium">${count.toLocaleString('pt-BR')}</span></div>`;
            }
        }
        function renderAnaliseAvarias(avariasData) {
            const page = document.getElementById('page-analise-avarias');
            if (page.innerHTML !== '') return; // Renderiza só uma vez
            page.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-semibold mb-4">Avarias por Tipo</h3><div id="chart-avarias-tipo" class="space-y-4"></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-semibold mb-4">Avarias por Turno</h3><div id="chart-avarias-turno" class="flex justify-around text-center"></div></div></div><div class="mt-6 bg-white p-6 rounded-lg shadow-sm"><h3 class="font-semibold mb-4">Registros de Avaria</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-3">Data</th><th class="p-3">Order ID</th><th class="p-3">Colaborador</th><th class="p-3">Líder</th><th class="p-3">Tipo Avaria</th></tr></thead><tbody id="table-avarias-body"></tbody></table></div></div>`;
            updateAnaliseAvarias(avariasData);
        }
        function updateAnaliseAvarias(avariasData) {
             const createBarHTML = (label, count, total, colorClass) => { const percentage = total > 0 ? ((count/total) * 100) : 0; return `<div class="flex items-center"><span class="w-40 text-sm text-gray-600">${label}</span><div class="w-full bg-gray-200 h-4 rounded-full"><div class="${colorClass} h-4 rounded-full" style="width: ${percentage}%"></div></div><span class="w-16 text-right text-sm font-medium">${count}</span></div>`; };
            const porTipo = avariasData.reduce((acc, row) => { acc[row['Tipo Avaria']] = (acc[row['Tipo Avaria']] || 0) + 1; return acc; }, {});
            if(document.getElementById('chart-avarias-tipo')) document.getElementById('chart-avarias-tipo').innerHTML = Object.entries(porTipo).map(([label, count]) => createBarHTML(label || 'N/A', count, avariasData.length, 'shopee-orange')).join('');
            const porTurno = avariasData.reduce((acc, row) => { acc[row['Turno']] = (acc[row['Turno']] || 0) + 1; return acc; }, {});
            if(document.getElementById('chart-avarias-turno')) document.getElementById('chart-avarias-turno').innerHTML = Object.entries(porTurno).map(([label, count]) => `<div><p class="text-2xl font-bold">${count}</p><p class="text-sm text-gray-500">${label || 'N/A'}</p></div>`).join('');
            const tableBody = document.getElementById('table-avarias-body');
            if(tableBody) { tableBody.innerHTML = ''; avariasData.slice(0, 100).forEach(row => { tableBody.innerHTML += `<tr class="border-b"><td class="p-3">${row['Data']}</td><td class="p-3 font-medium">${row['BR (Order ID)']}</td><td class="p-3">${row['Colaborador']}</td><td class="p-3">${row['Líder Responsável']}</td><td class="p-3">${row['Tipo Avaria']}</td></tr>`; }); }
        }
        function renderNaoCoube(naoCoubeData) {
            const page = document.getElementById('page-nao-coube');
            if (page.innerHTML !== '') return;
            page.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="kpi-card bg-white p-6 rounded-lg shadow-sm"><h3 class="text-gray-500 text-sm font-medium">"Não Coube" no Período</h3><p id="kpi-naocoube-periodo" class="text-3xl font-bold text-gray-800 mt-2">0</p></div><div class="kpi-card bg-white p-6 rounded-lg shadow-sm"><h3 class="text-gray-500 text-sm font-medium">Pedidos Repetidos</h3><p id="kpi-naocoube-repetidos" class="text-3xl font-bold text-gray-800 mt-2">0</p></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-semibold mb-4">Lista de Pedidos Repetidos ("Não Coube")</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600"><tr><th class="p-3">Order ID</th><th class="p-3">Qtd. Repetições</th><th class="p-3">Última Ocorrência</th><th class="p-3">Recebedor</th></tr></thead><tbody id="table-naocoube-body"></tbody></table></div></div>`;
            updateNaoCoube(naoCoubeData);
        }
        function updateNaoCoube(naoCoubeData) {
            document.getElementById('kpi-naocoube-periodo').textContent = naoCoubeData.length.toLocaleString('pt-BR');
            const repetidos = naoCoubeData.reduce((acc, row) => { const orderId = row['Order_Id']; if (orderId) { if (!acc[orderId]) acc[orderId] = { count: 0, lastDate: '', recebedor: '' }; acc[orderId].count++; acc[orderId].lastDate = row['Data']; acc[orderId].recebedor = row['Recebedor']; } return acc; }, {});
            const repetidosFiltrados = Object.entries(repetidos).filter(([id, data]) => data.count > 1);
            document.getElementById('kpi-naocoube-repetidos').textContent = repetidosFiltrados.length.toLocaleString('pt-BR');
            const tableBody = document.getElementById('table-naocoube-body');
            if(tableBody) { tableBody.innerHTML = ''; repetidosFiltrados.sort((a,b) => b[1].count - a[1].count).forEach(([orderId, data]) => { tableBody.innerHTML += `<tr class="border-b"><td class="p-3 font-medium">${orderId}</td><td class="p-3"><span class="bg-red-100 text-red-800 font-bold px-2 py-1 rounded">${data.count}</span></td><td class="p-3">${data.lastDate}</td><td class="p-3">${data.recebedor || '#N/A'}</td></tr>`; }); }
        }
        document.getElementById('date-filters').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); currentPeriod = e.target.dataset.period; renderDashboard(); }});
        const pages = ['visao-geral', 'analise-avarias', 'nao-coube']; const navItems = document.querySelectorAll('.sidebar-item');
        function showPage(pageId) { pages.forEach(id => document.getElementById(`page-${id}`).classList.add('hidden')); navItems.forEach(item => { item.classList.remove('active'); const svg = item.querySelector('svg'); if (svg) { svg.classList.remove('text-white'); svg.classList.add('text-gray-500'); } }); document.getElementById(`page-${pageId}`).classList.remove('hidden'); const activeNavItem = document.getElementById(`nav-${pageId}`); activeNavItem.classList.add('active'); const activeSvg = activeNavItem.querySelector('svg'); if (activeSvg) { activeSvg.classList.remove('text-gray-500', 'shopee-orange-text'); activeSvg.classList.add('text-white'); } renderDashboard(); }
        function parseDate(dateString) { if (!dateString || typeof dateString !== 'string') return null; const parts = dateString.match(/(\d{1,2})[/-](\d{1,2})[/-](\d{4})/); if (parts) { return new Date(parts[3], parts[2] - 1, parts[1]); } return new Date(dateString); }
        function filterDataByPeriod(data, dateColumn) { if (!data) return []; const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay()); const monthStart = new Date(today.getFullYear(), today.getMonth(), 1); return data.filter(row => { const rowDate = parseDate(row[dateColumn]); if (!rowDate || isNaN(rowDate.getTime())) return false; switch (currentPeriod) { case 'today': return rowDate.getTime() === today.getTime(); case 'week': return rowDate >= weekStart; case 'month': return rowDate >= monthStart; case 'all': default: return true; } }); }
    </script>
</body>
</html>
